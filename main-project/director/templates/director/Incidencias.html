{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="{% static 'css/style_incidencias.css' %}"
    />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">

    <title>incidencias</title>
  </head>
  <body>
    <header class="header">
      <div class="logo">
        <img
          src="https://cdn-icons-png.flaticon.com/512/2228/2228497.png"
          alt="Logo Municipalidad"
        />
        <a href="#">Municipalidad</a>
      </div>
      <div class="user">
        <img
          src="https://icons.veryicon.com/png/o/miscellaneous/icon-the-back-office-management-system/administrator-role-management.png"
          class="user-pic"
          alt="Usuario"
        />
      </div>
    </header>
    <main class="main-container">
      <aside class="sidebar">
        <ul>
          <li>
            <a href="{% url 'director:dashboard' %}">Dashboard</a>
            <a href="{% url 'director:incidencias' %}">Incidencias</a>
            <a href="{% url 'director:crear_formulario' %}">formulario</a>
          </li>
        </ul>
      </aside>
      <section class="content">
        {% if messages %}
        <div class="alert alert-success" role="alert">
          {% for message in messages %}
            {{ message }}
          {% endfor %}
        </div>
        {% endif %}
        <div class="container-box">
          <div class="table-responsive">

            <h2>Incidencias</h2>
            <table class="table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Direccion de multimedia</th>
                  <th>Gestor Territorial</th>
                  <th>Título</th>
                  <th>Estado de Incidencia</th>
                  <th>Descripcion</th>
                  <th>Fecha de Creacion</th>
                  <th>Nivel de Urgencia</th>
                  <th>Resolutor Asignado</th>
                  <th>Latitud</th>
                  <th>Longitud</th>
                  <th>Usuario de Departamento</th>
                  <th>Opciones</th>
                </tr>   
              </thead>
            </thead>
            <tbody>
                {% for i in incidencia %}
                <tr>
                  <td>{{ i.id }}</td>
                  <td>{{ i.direccion_multimedia }}</td>
                  <td>{{ i.id_usuario_gestorTerritorial }}</td>
                  <td>{{ i.titulo_Incidencia }}</td>
                  <td>{{ i.estado }}</td>
                  <td>{{ i.descripcion }}</td>
                  <td>{{ i.fecha_Reporte }}</td>
                  <td>{{ i.urgencia }}</td>
                  <td>{{ i.resolutor_Asignado }}</td>
                  <td>{{ i.latitud }}</td>
                  <td>{{ i.longitud }}</td>
                  <td>{{ i.id_usuario_departamennto}}</td>
                  <td>
                    <button class="btn btn-info" data-toggle="modal" data-target="#asignarUsuarioModal" data-id="{{ i.id }}">Asignar usuario</button>
                    <a href="{% url 'director:deshacerAsignacion' i.id %}" class="btn btn-danger">deshacer asignacion</a>
                    <button class="btn btn-danger" data-toggle="modal" data-target="#rechazoModal" data-id="{{ i.id }}" data-user="{{ i.id_usuario_gestorTerritorial }}">Rechazar incidencia</button>
                  </td>
                {% endfor %}
              </tr>
            </tbody>
            </table>
          </div>
        </div>
      </section>
    </main>

    <!-- Modal Asignar Usuario -->
    <div class="modal fade" id="asignarUsuarioModal" tabindex="-1" role="dialog" aria-labelledby="asignarUsuarioModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="asignarUsuarioModalLabel">Asignar Usuario</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form action="{% url 'director:asignarUsuario' %}" method="POST">
              {% csrf_token %}
              <div class="form-group">
                <label for="ID">ID de Incidencia</label>
                <input type="text" id="ID_asignar" name="ID_asignar" class="form-control" readonly required />
              </div>
              <div class="form-group">
                <label for="usuario_id">Seleccione un Usuario</label>
                <select name="usuario_id" id="usuario_id" class="form-control" required>
                  <option value="" disabled selected>Seleccione un usuario</option>
                  {% for usuario in usuarios %}
                  <option value="{{ usuario.id }}">{{ usuario.nombre }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="form-group text-right">
                <button type="submit" class="btn btn-success">Actualizar</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Modal rechazo -->
    <div class="modal fade" id="rechazoModal" tabindex="-1" role="dialog" aria-labelledby="rechazoModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="rechazoModalLabel">Rechazar Incidencia</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form action="{% url 'director:rechazarIncidencia' %}" method="POST">
              {% csrf_token %}
              <div class="form-group">
                <label for="ID">ID de Incidencia</label>
                <input type="text" id="ID_rechazo" name="ID_rechazo" class="form-control" readonly required />
              </div>
              <div class="form-group">
                <label for="user">Usuario Asignado</label>
                <input type="text" id="user_rechazo" name="user_rechazo" class="form-control" value="{{incidencia.usuario_asignado}}" readonly required>
              </div>
              <div class="form-group">
                <label for="justificacion">Justificación</label>
                <textarea id="justificacion" name="justificacion" placeholder="Ingrese su justificacion..." class="form-control" required></textarea>
              </div>
              <div class="form-group text-right">
                <button type="submit" class="btn btn-success">Actualizar</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const modal = document.getElementById("asignarUsuarioModal");
        const inputID = modal.querySelector("#ID_asignar");
    
        $('#asignarUsuarioModal').on('show.bs.modal', function (event) {
          const button = event.relatedTarget;
          const idIncidencia = button.getAttribute("data-id");
          inputID.value = idIncidencia;
        });
      });
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const rechazoModal = document.getElementById("rechazoModal");
    
        $('#rechazoModal').on('show.bs.modal', function (event) {
          const button = event.relatedTarget;
    
          const idIncidencia = button.getAttribute("data-id");
          const usuarioAsignado = button.getAttribute("data-user");
    
          rechazoModal.querySelector("#ID_rechazo").value = idIncidencia;
          rechazoModal.querySelector("#user_rechazo").value = usuarioAsignado;
        });
      });
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js" integrity="sha384-+sLIOodYLS7CIrQpBjl+C7nPvqq+FbNUBDunl/OZv93DB7Ln/533i8e/mZXLi/P+" crossorigin="anonymous"></script>
  </body>
</html>
