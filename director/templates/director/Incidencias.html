{% extends './base.html' %}  <!-- Extiende la plantilla base para reutilizar el diseño principal -->

{% block title %} Incidencias {% endblock %} <!-- Define el título de la página -->

{% block body %}
<div class="row">  <!-- Contenedor principal para la fila de contenido -->
  <div class="container-box">  <!-- Contenedor para la caja que contiene la tabla -->
    <div class="table-responsive">  <!-- Hace que la tabla sea desplazable en pantallas pequeñas -->

      <h2>Incidencias</h2>  <!-- Título de la página que indica que se mostrarán las incidencias -->
      <table class="table table-bordered table-hover table-striped text-center">  <!-- Tabla con clases para estilo y formato -->
        <thead class="thead-dark">  <!-- Cabecera de la tabla con fondo oscuro -->
          <tr>
            <th>#</th>  <!-- Número de la incidencia -->
            <th>Direccion de multimedia</th>  <!-- Dirección de multimedia asociada -->
            <th>Gestor Territorial</th>  <!-- Usuario del Gestor Territorial -->
            <th>Título</th>  <!-- Título de la incidencia -->
            <th>Estado de Incidencia</th>  <!-- Estado de la incidencia -->
            <th>Descripcion</th>  <!-- Descripción de la incidencia -->
            <th>Fecha de Creacion</th>  <!-- Fecha de creación de la incidencia -->
            <th>Nivel de Urgencia</th>  <!-- Nivel de urgencia de la incidencia -->
            <th>Resolutor Asignado</th>  <!-- Resolutor asignado para la incidencia -->
            <th>Latitud</th>  <!-- Latitud asociada a la incidencia -->
            <th>Longitud</th>  <!-- Longitud asociada a la incidencia -->
            <th>Usuario de Departamento</th>  <!-- Usuario del Departamento asignado -->
            <th>Opciones</th>  <!-- Opciones para gestionar la incidencia -->
          </tr>   
        </thead>
        <tbody>
          {% for i in incidencia %}  <!-- Bucle para recorrer la lista de incidencias y mostrar los datos -->
          <tr>
            <td>{{ i.id }}</td>  <!-- ID de la incidencia -->
            <td>{{ i.direccion_multimedia }}</td>  <!-- Dirección multimedia -->
            <td>{{ i.id_usuario_gestorTerritorial }}</td>  <!-- ID del Gestor Territorial -->
            <td>{{ i.titulo_Incidencia }}</td>  <!-- Título de la incidencia -->
            <td>{{ i.estado }}</td>  <!-- Estado de la incidencia -->
            <td>{{ i.descripcion }}</td>  <!-- Descripción de la incidencia -->
            <td>{{ i.fecha_Reporte }}</td>  <!-- Fecha del reporte -->
            <td>{{ i.urgencia }}</td>  <!-- Nivel de urgencia -->
            <td>{{ i.resolutor_Asignado }}</td>  <!-- Resolutor asignado -->
            <td>{{ i.latitud }}</td>  <!-- Latitud -->
            <td>{{ i.longitud }}</td>  <!-- Longitud -->
            <td>{{ i.id_usuario_departamennto }}</td>  <!-- ID del usuario del Departamento -->
            <td class="btn-group">  <!-- Botones de acción dentro de un grupo -->
              <button class="btn btn-info mr-2" data-toggle="modal" data-target="#asignarUsuarioModal" data-id="{{ i.id }}">Asignar usuario</button>  <!-- Botón para asignar un usuario -->
              <a href="{% url 'director:deshacerAsignacion' i.id %}" class="btn btn-danger mr-2">deshacer asignacion</a>  <!-- Enlace para deshacer la asignación -->
              <button class="btn btn-danger mr-2" data-toggle="modal" data-target="#rechazoModal" data-id="{{ i.id }}" data-user="{{ i.id_usuario_gestorTerritorial }}">Rechazar incidencia</button>  <!-- Botón para rechazar la incidencia -->
            </td>
          {% endfor %}
        </tr>
      </tbody>
      </table>
    </div>
  </div>
</div>
</section>

<!-- Modal para Asignar Usuario -->
<div class="modal fade" id="asignarUsuarioModal" tabindex="-1" role="dialog" aria-labelledby="asignarUsuarioModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="asignarUsuarioModalLabel">Asignar Usuario</h5>  <!-- Título del modal -->
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">  <!-- Botón para cerrar el modal -->
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form action="{% url 'director:asignarUsuario' %}" method="POST">  <!-- Formulario para asignar un usuario -->
          {% csrf_token %}
          <div class="form-group">
            <label for="ID">ID de Incidencia</label>  <!-- Etiqueta para el campo de ID -->
            <input type="text" id="ID_asignar" name="ID_asignar" class="form-control" readonly required />  <!-- Campo de ID de incidencia -->
          </div>
          <div class="form-group">
            <label for="usuario_id">Seleccione un Usuario</label>  <!-- Etiqueta para el campo de selección de usuario -->
            <select name="usuario_id" id="usuario_id" class="form-control" required>
              <option value="" disabled selected>Seleccione un usuario</option>  <!-- Opción por defecto -->
              {% for usuario in usuarios %}  <!-- Bucle para listar los usuarios -->
              <option value="{{ usuario.id }}">{{ usuario.nombre }}</option>  <!-- Opción para cada usuario -->
              {% endfor %}
            </select>
          </div>
          <div class="form-group text-right">
            <button type="submit" class="btn btn-success">Actualizar</button>  <!-- Botón para enviar el formulario -->
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Rechazar Incidencia -->
<div class="modal fade" id="rechazoModal" tabindex="-1" role="dialog" aria-labelledby="rechazoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="rechazoModalLabel">Rechazar Incidencia</h5>  <!-- Título del modal -->
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>  <!-- Botón para cerrar el modal -->
        </button>
      </div>
      <div class="modal-body">
        <form action="{% url 'director:rechazarIncidencia' %}" method="POST">  <!-- Formulario para rechazar la incidencia -->
          {% csrf_token %}
          <div class="form-group">
            <label for="ID">ID de Incidencia</label>  <!-- Etiqueta para el campo de ID -->
            <input type="text" id="ID_rechazo" name="ID_rechazo" class="form-control" readonly required />  <!-- Campo de ID de incidencia -->
          </div>
          <div class="form-group">
            <label for="user">Gestor Territorial</label>  <!-- Etiqueta para el campo de Gestor Territorial -->
            <input type="text" id="user_rechazo" name="user_rechazo" class="form-control" value="{{incidencia.id_usuario_gestorTerritorial}}" readonly required>  <!-- Campo de Gestor Territorial -->
          </div>
          <div class="form-group">
            <label for="justificacion">Justificación</label>  <!-- Etiqueta para el campo de justificación -->
            <textarea id="justificacion" name="justificacion" placeholder="Ingrese su justificacion..." class="form-control" required></textarea>  <!-- Campo para ingresar la justificación -->
          </div>
          <div class="form-group text-right">
            <button type="submit" class="btn btn-success">Actualizar</button>  <!-- Botón para enviar el formulario -->
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const modal = document.getElementById("asignarUsuarioModal");
  const inputID = modal.querySelector("#ID_asignar");

  // Al mostrar el modal, se asigna el ID de incidencia al campo correspondiente
  $('#asignarUsuarioModal').on('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    const idIncidencia = button.getAttribute("data-id");
    inputID.value = idIncidencia;
  });
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const rechazoModal = document.getElementById("rechazoModal");

  // Al mostrar el modal, se asignan los datos de la incidencia y usuario
  $('#rechazoModal').on('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    const idIncidencia = button.getAttribute("data-id");
    const usuarioAsignado = button.getAttribute("data-user");

    rechazoModal.querySelector("#ID_rechazo").value = idIncidencia;
    rechazoModal.querySelector("#user_rechazo").value = usuarioAsignado;
  });
});
</script>
</div>
{%endblock%}
